<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>DEBUG Watermark - Full Logging</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #1e1e1e; color: #fff; }
        .section { background: #2d2d2d; padding: 20px; margin: 10px 0; border-radius: 8px; }
        button { padding: 12px 24px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #555; }
        input, select { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        .hide { display: none; }
        img { max-width: 500px; margin: 10px 0; }
        h1 { color: #3498db; }
        h2 { color: #e74c3c; }
    </style>
</head>
<body>
    <h1>🔍 DEBUG MODE - Full Watermark Test</h1>
    <h2>⚠️ Watch the browser console (F12) and terminal for detailed logs</h2>
    
    <div class="section">
        <h3>Step 1: Login</h3>
        <button onclick="doLogin()">Quick Login</button>
        <div id="loginStatus"></div>
    </div>

    <div class="section hide" id="uploadSection">
        <h3>Step 2: Watermark</h3>
        <input type="file" id="imageFile" accept="image/*"><br>
        <input type="text" id="owner" placeholder="Owner" value="Test Owner"><br>
        <input type="text" id="creator" placeholder="Creator" value="Test Creator"><br>
        <input type="date" id="dateCreated"><br>
        <input type="text" id="title" placeholder="Title" value="Test Title"><br>
        <button onclick="doWatermark()" id="wmBtn">Watermark Image</button>
    </div>

    <div class="section hide" id="successSection">
        <h3>✅ SUCCESS - NO RESET!</h3>
        <img id="resultImg">
        <br><button onclick="reset()">Again</button>
    </div>

    <script>
        const API = 'http://localhost:5000/api';
        let step = 0;

        function log(msg) {
            step++;
            const full = `[STEP ${step}] ${msg}`;
            console.log(`%c${full}`, 'background: #2c3e50; color: #3498db; font-weight: bold; padding: 4px;');
        }

        function logError(msg) {
            step++;
            const full = `[STEP ${step}] ❌ ${msg}`;
            console.error(`%c${full}`, 'background: #e74c3c; color: white; font-weight: bold; padding: 4px;');
        }

        function logSuccess(msg) {
            step++;
            const full = `[STEP ${step}] ✅ ${msg}`;
            console.log(`%c${full}`, 'background: #27ae60; color: white; font-weight: bold; padding: 4px;');
        }

        // Monitor ALL navigation attempts
        const _href = Object.getOwnPropertyDescriptor(window.location, 'href').set;
        Object.defineProperty(window.location, 'href', {
            set: function(val) {
                logError(`BLOCKED REDIRECT TO: ${val}`);
                console.trace();
                // _href.call(window.location, val); // Uncomment to allow redirect
            }
        });

        window.addEventListener('beforeunload', () => {
            logError('⚠️⚠️⚠️ PAGE IS UNLOADING/RESETTING! ⚠️⚠️⚠️');
        });

        document.getElementById('dateCreated').value = new Date().toISOString().split('T')[0];

        async function doLogin() {
            log('🔐 Starting login...');
            try {
                const ts = Date.now();
                const user = {
                    username: `debug${ts}`,
                    email: `debug${ts}@test.com`,
                    password: 'Test123!',
                    full_name: 'Debug User'
                };

                log('📤 Registering user...');
                let res = await fetch(`${API}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                });
                log(`📥 Register response: ${res.status}`);

                log('📤 Logging in...');
                res = await fetch(`${API}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username: user.username, password: user.password })
                });
                log(`📥 Login response: ${res.status}`);

                if (res.ok) {
                    logSuccess(`Logged in as ${user.username}`);
                    document.getElementById('loginStatus').innerHTML = '✅ Logged in';
                    document.getElementById('uploadSection').classList.remove('hide');
                }
            } catch (e) {
                logError(`Login error: ${e.message}`);
            }
        }

        async function doWatermark() {
            log('🎨 Starting watermark process...');
            
            const fileInput = document.getElementById('imageFile');
            const btn = document.getElementById('wmBtn');

            if (!fileInput.files[0]) {
                logError('No file selected!');
                alert('Select a file first');
                return;
            }

            btn.disabled = true;
            log('🔒 Button disabled');

            try {
                log(`📁 File: ${fileInput.files[0].name}`);
                
                log('🔄 Converting to base64...');
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        log('✅ FileReader onload triggered');
                        resolve(reader.result);
                    };
                    reader.onerror = (e) => {
                        logError(`FileReader error: ${e}`);
                        reject(e);
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                });
                logSuccess('Base64 conversion complete');

                log('📦 Preparing FormData...');
                const fd = new FormData();
                fd.append('image', base64);
                fd.append('owner', document.getElementById('owner').value);
                fd.append('creator', document.getElementById('creator').value);
                fd.append('dateCreated', document.getElementById('dateCreated').value);
                fd.append('title', document.getElementById('title').value);
                fd.append('description', 'Debug test');
                fd.append('copyright', '© 2025');
                fd.append('medium', 'Photography');
                fd.append('category', 'Fine Art');
                log('✅ FormData prepared');

                log('📤 Sending request to backend...');
                log(`   URL: ${API}/watermark/embed`);
                log(`   Method: POST`);
                log(`   Credentials: include`);

                const res = await fetch(`${API}/watermark/embed`, {
                    method: 'POST',
                    credentials: 'include',
                    body: fd
                });

                log(`📥 Response received`);
                log(`   Status: ${res.status} ${res.statusText}`);
                log(`   Headers: ${JSON.stringify([...res.headers.entries()])}`);

                if (!res.ok) {
                    const err = await res.json();
                    logError(`Backend error: ${JSON.stringify(err)}`);
                    alert(`Error: ${err.error}`);
                    return;
                }

                log('📝 Parsing JSON response...');
                const result = await res.json();
                logSuccess('Response parsed successfully');
                log(`   Image ID: ${result.image_id}`);
                log(`   PSNR: ${result.psnr} dB`);
                log(`   Has watermarked_image: ${!!result.watermarked_image}`);

                log('🖼️ Setting image src...');
                document.getElementById('resultImg').src = 'data:image/png;base64,' + result.watermarked_image;
                logSuccess('Image src set');

                log('👁️ Hiding upload section...');
                document.getElementById('uploadSection').classList.add('hide');
                logSuccess('Upload section hidden');

                log('✨ Showing success section...');
                document.getElementById('successSection').classList.remove('hide');
                logSuccess('Success section shown');

                logSuccess('🎉🎉🎉 WATERMARK COMPLETE - NO RESET! 🎉🎉🎉');

            } catch (e) {
                logError(`Exception: ${e.message}`);
                logError(`Stack: ${e.stack}`);
                alert(`Error: ${e.message}`);
            } finally {
                log('🔓 Re-enabling button...');
                btn.disabled = false;
                logSuccess('Button re-enabled');
            }
        }

        function reset() {
            log('🔄 Resetting...');
            document.getElementById('successSection').classList.add('hide');
            document.getElementById('uploadSection').classList.remove('hide');
            document.getElementById('imageFile').value = '';
            logSuccess('Reset complete');
        }

        log('✅ Page loaded');
        log('🔍 All navigation attempts will be logged');
        log('⚠️ Check BOTH browser console AND terminal for logs');
    </script>
</body>
</html>

