<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Simple Watermark Test - No Redirects</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .section { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; }
        button { padding: 12px 24px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #95a5a6; }
        input { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        .hide { display: none; }
        img { max-width: 500px; margin: 10px 0; }
        h1 { color: #2c3e50; }
        .log { font-family: monospace; font-size: 12px; padding: 5px; margin: 2px 0; background: #ecf0f1; border-radius: 3px; }
        .error { background: #e74c3c; color: white; }
        .success { background: #27ae60; color: white; }
    </style>
</head>
<body>
    <h1>üß™ Simple Watermark Test</h1>
    
    <div class="section">
        <h3>Step 1: Quick Setup</h3>
        <button onclick="setup()">Create User & Set Auth</button>
        <div id="setupStatus"></div>
    </div>

    <div class="section hide" id="uploadSection">
        <h3>Step 2: Watermark</h3>
        <input type="file" id="imageFile" accept="image/*"><br>
        <button onclick="doWatermark()">Watermark Image</button>
    </div>

    <div class="section hide" id="successSection">
        <h3>‚úÖ SUCCESS!</h3>
        <p>Watermarked image:</p>
        <img id="resultImg">
        <br><button onclick="reset()">Again</button>
    </div>

    <div class="section">
        <h3>Log:</h3>
        <div id="log"></div>
    </div>

    <script>
        const API = 'http://localhost:5000/api';

        function log(msg, type = '') {
            const div = document.createElement('div');
            div.className = 'log ' + type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('log').appendChild(div);
            console.log(msg);
        }

        window.addEventListener('beforeunload', () => {
            log('‚ö†Ô∏è PAGE UNLOADING!', 'error');
        });

        async function setup() {
            log('Creating user...');
            const ts = Date.now();
            const user = {
                username: `user${ts}`,
                email: `user${ts}@test.com`,
                password: 'Test123!',
                full_name: 'Test User'
            };

            try {
                // Register
                let res = await fetch(`${API}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                });
                
                if (!res.ok) throw new Error('Registration failed');
                log('‚úÖ User registered', 'success');

                // Login
                res = await fetch(`${API}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username: user.username, password: user.password })
                });

                if (!res.ok) throw new Error('Login failed');
                
                const result = await res.json();
                log('‚úÖ Login successful', 'success');
                
                // IMPORTANT: Store auth in localStorage as backup
                localStorage.setItem('pixelledger_authenticated', 'true');
                localStorage.setItem('pixelledger_user', JSON.stringify(result.user));
                localStorage.setItem('pixelledger_token', result.token);
                
                log('‚úÖ Auth stored in localStorage', 'success');
                
                document.getElementById('setupStatus').innerHTML = '<div class="log success">‚úÖ Ready to watermark</div>';
                document.getElementById('uploadSection').classList.remove('hide');

            } catch (e) {
                log(`‚ùå Error: ${e.message}`, 'error');
            }
        }

        async function doWatermark() {
            log('Starting watermark...');
            
            const fileInput = document.getElementById('imageFile');
            if (!fileInput.files[0]) {
                alert('Select a file first');
                return;
            }

            try {
                log('Converting to base64...');
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(fileInput.files[0]);
                });

                log('Preparing request...');
                const fd = new FormData();
                fd.append('image', base64);
                fd.append('owner', 'Test Owner');
                fd.append('creator', 'Test Creator');
                fd.append('dateCreated', new Date().toISOString().split('T')[0]);
                fd.append('title', 'Test');
                fd.append('description', 'Test');
                fd.append('copyright', '¬© 2025');
                fd.append('medium', 'Photography');
                fd.append('category', 'Fine Art');

                log('Sending request...');
                
                // Get token from localStorage
                const token = localStorage.getItem('pixelledger_token');
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const res = await fetch(`${API}/watermark/embed`, {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include',
                    body: fd
                });

                log(`Response: ${res.status}`);

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || `HTTP ${res.status}`);
                }

                const result = await res.json();
                log('‚úÖ Watermark created!', 'success');
                log(`Image ID: ${result.image_id}`);
                log(`PSNR: ${result.psnr} dB`);

                document.getElementById('resultImg').src = 'data:image/png;base64,' + result.watermarked_image;
                document.getElementById('uploadSection').classList.add('hide');
                document.getElementById('successSection').classList.remove('hide');

                log('‚úÖ SUCCESS - NO RESET!', 'success');

            } catch (e) {
                log(`‚ùå Error: ${e.message}`, 'error');
            }
        }

        function reset() {
            document.getElementById('successSection').classList.add('hide');
            document.getElementById('uploadSection').classList.remove('hide');
            document.getElementById('imageFile').value = '';
        }

        log('Page loaded');
    </script>
</body>
</html>

